<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Checkout | JD Store</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

<style>
body{
  margin:0;
  font-family:Poppins,sans-serif;
  background:radial-gradient(circle at top,#0b0b0b,#000);
  color:#fff;
}

.container{
  max-width:900px;
  margin:40px auto;
  padding:20px;
}

.card{
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.12);
  border-radius:20px;
  padding:24px;
  margin-bottom:24px;
}

h2{margin-bottom:16px}

input, textarea{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:none;
  margin-bottom:14px;
  font-family:inherit;
}

textarea{resize:none}

.cart-item{
  display:flex;
  justify-content:space-between;
  margin-bottom:10px;
}

.total{
  font-size:18px;
  font-weight:600;
  margin-top:12px;
}

button{
  width:100%;
  padding:14px;
  border:none;
  border-radius:14px;
  background:linear-gradient(135deg,#4da3ff,#2563eb);
  color:#fff;
  font-size:16px;
  cursor:pointer;
}
button:disabled{opacity:.6}
</style>
</head>

<body>

<div class="container">

  <!-- ADDRESS -->
  <div class="card">
    <h2>Delivery Details</h2>
    <input id="name" placeholder="Full Name">
    <input id="phone" placeholder="Phone Number">
    <textarea id="address" rows="3" placeholder="Delivery Address"></textarea>
  </div>

  <!-- ORDER SUMMARY -->
  <div class="card">
    <h2>Order Summary</h2>
    <div id="orderItems"></div>
    <div class="total" id="orderTotal"></div>
  </div>

  <!-- PLACE ORDER -->
  <button id="placeOrderBtn">Place Order</button>

</div>

<script src="../config.js"></script>
<script>
"use strict";

/* ================= CONFIG ================= */
const API_BASE = window.APP_CONFIG.API_BASE;
const API_ORDERS = API_BASE + "/api/orders";
const API_PROFILE = API_BASE + "/api/profile";

/* ================= USER ================= */
const USER_ID = localStorage.getItem("jd_user_id");
if (!USER_ID) {
  alert("Please login first");
  location.href = "../index.html";
}

/* ================= CART ================= */
const CART_KEY = "jd_cart";
const cart = JSON.parse(localStorage.getItem(CART_KEY)) || [];
if (cart.length === 0) {
  alert("Cart is empty");
  location.href = "../index.html";
}

/* ================= ELEMENTS ================= */
const nameI = document.getElementById("name");
const phoneI = document.getElementById("phone");
const addressI = document.getElementById("address");
const itemsBox = document.getElementById("orderItems");
const totalBox = document.getElementById("orderTotal");
const btn = document.getElementById("placeOrderBtn");

/* ================= LOAD PROFILE ================= */
fetch(API_PROFILE, {
  headers:{ "x-user-id": USER_ID }
})
.then(r=>r.json())
.then(u=>{
  nameI.value = u.name || "";
  phoneI.value = u.phone || "";
  addressI.value = u.address || "";
});

/* ================= RENDER SUMMARY ================= */
let total = 0;
cart.forEach(i=>{
  total += i.price * i.qty;
  itemsBox.innerHTML += `
    <div class="cart-item">
      <span>${i.name} × ${i.qty}</span>
      <span>₹${(i.price * i.qty).toLocaleString("en-IN")}</span>
    </div>`;
});
totalBox.textContent = "Total: ₹" + total.toLocaleString("en-IN");

/* ================= PLACE ORDER ================= */
btn.onclick = async () => {

  if (!nameI.value || !phoneI.value || !addressI.value) {
    alert("Please fill all delivery details");
    return;
  }

  btn.disabled = true;
  btn.textContent = "Placing order...";

  try {
    const res = await fetch(API_ORDERS, {
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "x-user-id": USER_ID
      },
      body:JSON.stringify({
        items: cart.map(i=>({
          product_id: i.id,
          price: i.price,
          quantity: i.qty
        })),
        total
      })
    });

    if(!res.ok) throw new Error();

    const data = await res.json();
    localStorage.setItem("last_order_id", data.orderId);
    localStorage.removeItem(CART_KEY);

    location.href = "success.html";

  } catch {
    alert("Order failed");
    btn.disabled = false;
    btn.textContent = "Place Order";
  }
};
</script>

</body>
</html>
