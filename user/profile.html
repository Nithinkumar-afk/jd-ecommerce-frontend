<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Profile ‚Äì JD</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box}

body{
  font-family:Poppins,sans-serif;
  background:#000;
  color:white;
  min-height:100vh;
}

/* HEADER */
header{
  padding:16px 22px;
  border-bottom:1px solid #333;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
  flex-wrap:wrap;
}

header a{
  color:#4fb6e8;
  text-decoration:none;
  font-size:22px;
  font-weight:600;
}

.header-btn{
  padding:8px 14px;
  border-radius:12px;
  border:none;
  cursor:pointer;
  font-size:13px;
  font-weight:600;
  text-decoration:none;
  margin-left:6px;
}

.checkout-btn{background:#2563eb;color:white}
.logout{background:#dc2626;color:white}

/* CONTAINER */
.container{
  max-width:900px;
  margin:auto;
  padding:26px 22px;
}

.card{
  background:#0f172a;
  border-radius:22px;
  padding:24px;
}

/* PROFILE */
.profile-top{
  display:flex;
  gap:24px;
  align-items:center;
  flex-wrap:wrap;
}

.profile-pic{
  width:120px;
  height:120px;
  border-radius:50%;
  background:#1e293b;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:52px;
  overflow:hidden;
  flex-shrink:0;
}

.profile-pic img{
  width:100%;
  height:100%;
  object-fit:cover;
}

label{
  font-size:13px;
  color:#cbd5e1;
  margin-top:14px;
  display:block;
}

input,textarea{
  width:100%;
  margin-top:6px;
  padding:12px 14px;
  border-radius:14px;
  border:1px solid #334155;
  background:#020617;
  color:white;
  outline:none;
}

textarea{min-height:90px}

button{
  margin-top:18px;
  padding:14px;
  border-radius:16px;
  background:#2563eb;
  color:white;
  border:none;
  font-weight:600;
  cursor:pointer;
  width:100%;
}

/* ================= RESPONSIVE ================= */

/* Tablets */
@media (max-width: 900px){
  .container{
    padding:20px 16px;
  }

  .card{
    padding:20px;
  }
}

/* Mobile */
@media (max-width: 600px){
  header{
    flex-direction:column;
    align-items:flex-start;
  }

  header > div{
    width:100%;
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    justify-content:flex-start;
  }

  .header-btn{
    margin-left:0;
    flex:1;
    text-align:center;
  }

  .profile-top{
    flex-direction:column;
    align-items:flex-start;
  }

  .profile-pic{
    width:100px;
    height:100px;
    font-size:42px;
  }

  input,textarea{
    font-size:14px;
  }

  button{
    font-size:15px;
  }
}

/* Small phones */
@media (max-width: 380px){
  .profile-pic{
    width:90px;
    height:90px;
    font-size:36px;
  }

  .card{
    padding:16px;
  }
}
</style>
</head>

<body>

<header>
  <a href="../index.html">‚Üê</a>
  <div>
    My Profile
    <a href="checkout.html" class="header-btn checkout-btn">Checkout</a>
    <button class="header-btn logout" onclick="logout()">Logout</button>
  </div>
</header>

<div class="container">
<div class="card">

<div class="profile-top">
  <div class="profile-pic">
    <span id="avatar">üë§</span>
    <img id="profileImage" hidden>
  </div>

  <div style="flex:1">
    <label>Full Name</label>
    <input id="name">

    <label>Phone</label>
    <input id="phone">

    <label>Alternate Phone</label>
    <input id="altPhone">
  </div>
</div>

<label>Address</label>
<textarea id="address"></textarea>

<label>Profile Image</label>
<input type="file" id="imageInput" accept="image/*">

<button id="saveBtn">Save Profile</button>

</div>
</div>

<script src="../config.js"></script>
<script>
"use strict";

/* ================= CONFIG ================= */
const BASE_URL = window.APP_CONFIG.API_BASE;
const API_PROFILE = BASE_URL + "/api/profile";

/* ================= ELEMENTS ================= */
const nameI     = document.getElementById("name");
const phoneI    = document.getElementById("phone");
const altPhoneI = document.getElementById("altPhone");
const addressI  = document.getElementById("address");
const imageI    = document.getElementById("imageInput");
const img       = document.getElementById("profileImage");
const avatar    = document.getElementById("avatar");
const saveBtn   = document.getElementById("saveBtn");

/* ================= IMAGE SMOOTH SETUP ================= */
img.style.opacity = "0";
img.style.transition = "opacity .3s ease";

/* ================= USER ID ================= */
let USER_ID = localStorage.getItem("jd_user_id");

/* ================= FAST IMAGE LOADER ================= */
function loadImageSmooth(src){
  const pre = new Image();
  pre.src = src;
  pre.onload = () => {
    img.src = src;
    img.hidden = false;
    avatar.hidden = true;
    requestAnimationFrame(() => img.style.opacity = "1");
  };
}

/* ================= LOAD PROFILE ================= */
if (USER_ID) {
  fetch(API_PROFILE, {
    headers: { "x-user-id": USER_ID }
  })
  .then(r => r.ok ? r.json() : null)
  .then(user => {
    if (!user) return;

    nameI.value     = user.name || "";
    phoneI.value    = user.phone || "";
    altPhoneI.value = user.alt_phone || "";
    addressI.value  = user.address || "";

    if (user.image) {
      const imageURL = BASE_URL + user.image + "?t=" + Date.now();
      loadImageSmooth(imageURL);
    }
  })
  .catch(()=>{});
}

/* ================= SAVE PROFILE ================= */
saveBtn.onclick = async () => {

  if (!nameI.value || !phoneI.value || !addressI.value) {
    alert("Please fill all required fields");
    return;
  }

  const USER_ID = "jd_user_" + phoneI.value.trim();
  localStorage.setItem("jd_user_id", USER_ID);

  const fd = new FormData();
  fd.append("name", nameI.value);
  fd.append("phone", phoneI.value);
  fd.append("alt_phone", altPhoneI.value);
  fd.append("address", addressI.value);

  if (imageI.files[0]) fd.append("image", imageI.files[0]);

  try {
    const res = await fetch(API_PROFILE, {
      method: "POST",
      headers: { "x-user-id": USER_ID },
      body: fd
    });

    if (!res.ok) throw new Error();

    alert("Profile saved successfully ‚úÖ");

    if (imageI.files[0]) {
      img.style.opacity = "0";
      loadImageSmooth(URL.createObjectURL(imageI.files[0]));
    }

  } catch {
    alert("Save failed ‚ùå");
  }
};

/* ================= LOGOUT ================= */
function logout() {
  localStorage.removeItem("jd_user_id");
  location.href = "../index.html";
}
</script>

</body>
</html>
