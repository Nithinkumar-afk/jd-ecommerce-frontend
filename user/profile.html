<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Profile ‚Äì JD</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
  font-family:Poppins,sans-serif;
  background:black;
  color:white;
  min-height:100vh;
}
header{
  position:sticky;top:0;z-index:10;
  background:rgba(0,0,0,.85);
  backdrop-filter:blur(14px);
  border-bottom:1px solid rgba(255,255,255,.15);
  padding:18px 22px;
  display:flex;
  align-items:center;
  gap:14px;
}
header a{color:#4fb6e8;font-size:22px;text-decoration:none}
.container{max-width:920px;margin:auto;padding:28px 20px}

.card{
  background:rgba(255,255,255,.08);
  backdrop-filter:blur(18px);
  border-radius:24px;
  padding:28px;
  border:1px solid rgba(255,255,255,.15);
  box-shadow:0 30px 80px rgba(0,0,0,.85);
  margin-bottom:24px;
}

.profile-top{display:flex;gap:28px;align-items:center}

.profile-pic{
  width:130px;height:130px;border-radius:50%;
  background:linear-gradient(135deg,#4fb6e8,#2563eb);
  padding:5px;cursor:pointer;
}

.profile-pic img,
.emoji-avatar{
  width:100%;
  height:100%;
  border-radius:50%;
  object-fit:cover;
  background:black;
  border:3px solid rgba(255,255,255,.8);
}

.emoji-avatar{
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:56px;
}

label{
  font-size:13px;font-weight:600;color:#cbd5e1;
  margin-top:12px;display:block
}

input,textarea{
  width:100%;margin-top:6px;
  padding:14px 16px;border-radius:14px;
  border:1px solid rgba(255,255,255,.25);
  background:rgba(0,0,0,.4);
  color:white;font-family:Poppins,sans-serif
}

button{
  margin-top:16px;padding:14px 22px;
  border:none;border-radius:14px;
  font-weight:600;cursor:pointer
}

.primary{
  background:linear-gradient(135deg,#4fb6e8,#2563eb);
  color:white
}

.address-card{
  border:1px solid rgba(255,255,255,.2);
  border-radius:18px;
  padding:16px;margin-top:14px;
  display:flex;justify-content:space-between;
  background:rgba(0,0,0,.35)
}

.delete-btn{
  background:#ef4444;color:white;
  padding:8px 14px;border-radius:10px;
  font-size:13px;border:none
}

.empty{color:#94a3b8;font-size:14px;margin-top:10px}
</style>
</head>

<body>

<header>
  <a href="index.html">‚Üê</a>
  <h2>My Profile</h2>
</header>

<div class="container">

  <!-- PROFILE CARD -->
  <div class="card">
    <div class="profile-top">
      <div class="profile-pic" onclick="imgInput.click()">
        <div id="avatar" class="emoji-avatar">üë§</div>
        <img id="profileImage" hidden>
      </div>

      <div style="flex:1">
        <label>Full Name</label>
        <input id="name">

        <label>Primary Phone</label>
        <input id="phone">

        <label>Alternative Phone</label>
        <input id="altPhone">

        <input type="file" accept="image/*" hidden id="imgInput">
      </div>
    </div>

    <button class="primary" id="saveBtn">Save Profile</button>
  </div>

  <!-- ADD ADDRESS -->
  <div class="card">
    <h3>Add Address</h3>
    <textarea id="newAddress" rows="3"></textarea>
    <button class="primary" id="addAddressBtn">Save Address</button>
  </div>

  <!-- ADDRESS LIST -->
  <div class="card">
    <h3>Saved Addresses</h3>
    <div id="addressList"></div>
  </div>

</div>

<script>
const API = "https://shopx-production-b1ad.up.railway.app";

/* TOKEN */
const token =
  localStorage.getItem("userToken") ||
  localStorage.getItem("token");

if(!token){
  location.replace("login.html");
}

const authHeader = { Authorization: "Bearer " + token };

const nameInput=document.getElementById("name");
const phoneInput=document.getElementById("phone");
const altPhoneInput=document.getElementById("altPhone");
const profileImage=document.getElementById("profileImage");
const avatar=document.getElementById("avatar");
const imgInput=document.getElementById("imgInput");
const addressList=document.getElementById("addressList");
const saveBtn=document.getElementById("saveBtn");
const addAddressBtn=document.getElementById("addAddressBtn");
const newAddress=document.getElementById("newAddress");

/* LOAD PROFILE */
async function loadProfile(){
  try{
    const res = await fetch(API+"/api/profile",{ headers: authHeader });
    if(!res.ok) throw new Error();
    const d = await res.json();

    nameInput.value = d.name || "";
    phoneInput.value = d.phone || "";
    altPhoneInput.value = d.altPhone || "";

    if(d.image){
      profileImage.src = d.image.startsWith("http") ? d.image : API + d.image;
      profileImage.hidden = false;
      avatar.style.display = "none";
    }else{
      profileImage.hidden = true;
      avatar.style.display = "flex";
    }

    renderAddresses(d.addresses || []);
  }catch{
    alert("Failed to load profile");
  }
}

/* SAVE PROFILE */
saveBtn.onclick = async () => {
  const res = await fetch(API+"/api/profile",{
    method:"PUT",
    headers:{...authHeader,"Content-Type":"application/json"},
    body:JSON.stringify({
      name:nameInput.value.trim(),
      phone:phoneInput.value.trim(),
      altPhone:altPhoneInput.value.trim()
    })
  });

  if(!res.ok) return alert("Profile update failed");
  alert("Profile updated");
};

/* IMAGE UPLOAD */
imgInput.onchange = async () => {
  const file = imgInput.files[0];
  if(!file) return;

  const fd = new FormData();
  fd.append("image", file);

  const res = await fetch(API+"/api/profile/image",{
    method:"PUT",
    headers:authHeader,
    body:fd
  });

  if(res.ok){
    const d = await res.json();
    profileImage.src = API + d.image;
    profileImage.hidden = false;
    avatar.style.display = "none";
  }
};

/* ADDRESS */
addAddressBtn.onclick = async () => {
  const address = newAddress.value.trim();
  if(!address) return;

  await fetch(API+"/api/profile/address",{
    method:"POST",
    headers:{...authHeader,"Content-Type":"application/json"},
    body:JSON.stringify({address})
  });

  newAddress.value="";
  loadProfile();
};

function removeAddress(id){
  fetch(API+"/api/profile/address/"+id,{
    method:"DELETE",
    headers:authHeader
  }).then(loadProfile);
}

function renderAddresses(list){
  addressList.innerHTML="";
  if(!list.length){
    addressList.innerHTML='<p class="empty">No saved addresses</p>';
    return;
  }

  list.forEach(a=>{
    const div=document.createElement("div");
    div.className="address-card";
    div.innerHTML=`
      <div>${a.address}</div>
      <button class="delete-btn">Delete</button>
    `;
    div.querySelector("button").onclick=()=>removeAddress(a.id);
    addressList.appendChild(div);
  });
}

loadProfile();
</script>

</body>
</html>
