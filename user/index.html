<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JD</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

<style>
/* === STYLES UNCHANGED === */
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:Poppins,sans-serif;background:black;color:white}
/* (styles intentionally untouched for safety) */
</style>
</head>

<body>

<!-- UI UNCHANGED -->
<header>
  <div class="logo" onclick="location.href='index.html'">
    <span>J</span><span>D</span>
  </div>
  <input id="search" placeholder="Search products">
  <div class="header-right">
    <button class="profile-btn" id="profileBtn">
      <div class="avatar" id="avatar">U</div>
      <span class="profile-text">
        <strong id="userName">Account</strong>
        <small>My profile</small>
      </span>
    </button>

    <div class="dropdown" id="menu">
      <div class="dropdown-header">
        <strong id="dropName">User</strong>
        <small id="dropEmail">user@email.com</small>
      </div>
      <a href="profile.html">üë§ Profile</a>
      <a href="orders.html">üì¶ Orders</a>
      <a href="wishlist.html">‚ù§Ô∏è Wishlist</a>
      <hr>
      <a href="#" class="logout" onclick="logout()">üö™ Logout</a>
    </div>

    <button class="cart" onclick="location.href='cart.html'">
      Cart (<span id="cartCount">0</span>)
    </button>
  </div>
</header>

<div class="container">
  <div class="categories" id="categories"></div>
  <div class="products" id="products"></div>
</div>

<div id="toast" class="toast"></div>

<script>
/* SPLASH */
window.addEventListener("load", () => {
  setTimeout(() => {
    const splash = document.getElementById("splash");
    if (splash) splash.classList.add("hide");
  }, 2000);
});

/* ‚úÖ PRODUCTION API */
const API_BASE = "https://shopx-production-b1ad.up.railway.app";

/* ‚úÖ AUTO REDIRECT IF LOGGED IN */
if (localStorage.getItem("token")) {
  window.location.replace("index.html"); // user/index.html
}

const alertMsg = document.getElementById("alertMsg");
const otpBox = document.getElementById("otpBox");

function showAlert(msg, type = "success") {
  alertMsg.textContent = msg;
  alertMsg.className = `alert-msg alert-${type}`;
  alertMsg.classList.remove("hidden");
}

function validEmail(email) {
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
}

/* SEND OTP */
async function sendOTP() {
  const name = document.getElementById("name").value.trim();
  const email = document.getElementById("email").value.trim();

  if (!name || !email)
    return showAlert("Enter name & email", "error");

  if (!validEmail(email))
    return showAlert("Invalid email address", "error");

  try {
    const res = await fetch(`${API_BASE}/api/auth/send-otp`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name, email })
    });

    const data = await res.json();

    if (!res.ok)
      throw new Error(data.message || "OTP send failed");

    otpBox.classList.remove("hidden");
    showAlert("OTP sent successfully");

  } catch (err) {
    showAlert(err.message, "error");
  }
}

/* VERIFY OTP */
async function verifyOTP() {
  const email = document.getElementById("email").value.trim();
  const otp = document.getElementById("otp").value.trim();

  if (!otp)
    return showAlert("Enter OTP", "error");

  try {
    const res = await fetch(`${API_BASE}/api/auth/verify-otp`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, otp })
    });

    const data = await res.json();

    if (!res.ok)
      throw new Error(data.message || "OTP invalid");

    localStorage.setItem("token", data.token);
    localStorage.setItem("loggedInUser", JSON.stringify(data.user));

    window.location.replace("index.html"); // user/index.html

  } catch (err) {
    showAlert(err.message, "error");
  }
}
</script>

</body>
</html>
