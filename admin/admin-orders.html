<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>JD Admin – Orders</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

<style>
:root {
  --bg:#000;
  --card:#111;
  --border:#222;
  --text:#fff;
  --muted:#cbd5f5;
  --accent:orange;
}

* {
  box-sizing:border-box;
}

body {
  background:var(--bg);
  color:var(--text);
  font-family:Poppins;
  margin:0;
}

/* ================= HEADER ================= */
header {
  padding:18px 20px;
  font-size:24px;
  font-weight:600;
  border-bottom:1px solid var(--border);
}

/* ================= FILTERS ================= */
.filters {
  display:flex;
  gap:10px;
  padding:16px 20px;
  flex-wrap:wrap;
}

.filters button {
  padding:10px 16px;
  border:none;
  border-radius:999px;
  background:var(--card);
  color:var(--text);
  cursor:pointer;
  font-size:14px;
  white-space:nowrap;
}

.filters button.active {
  background:var(--accent);
  color:#000;
}

/* ================= CONTAINER ================= */
.container {
  padding:20px;
  max-width:1200px;
  margin:auto;
}

/* ================= ORDER CARD ================= */
.order {
  background:var(--card);
  padding:16px;
  border-radius:16px;
  margin-bottom:16px;
  border:1px solid var(--border);
}

.order b {
  font-weight:600;
}

/* ================= STATUS ================= */
.status {
  font-weight:600;
  margin-top:6px;
}

.PLACED { color:orange }
.SHIPPED { color:#38bdf8 }
.DELIVERED { color:#22c55e }
.CANCELLED { color:#ef4444 }

/* ================= ITEMS ================= */
.items {
  margin-top:10px;
  font-size:14px;
  color:var(--muted);
  line-height:1.6;
}

/* ================= ACTIONS ================= */
.actions {
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  margin-top:14px;
}

.actions button {
  padding:8px 16px;
  border:none;
  border-radius:10px;
  cursor:pointer;
  font-size:14px;
}

.ship { background:#0ea5e9; color:#000 }
.deliver { background:#22c55e; color:#000 }
.cancel { background:#ef4444; color:#000 }
.delete { background:#6b7280; color:#000 }

button:disabled {
  opacity:.5;
  cursor:not-allowed;
}

/* ================= MOBILE ================= */
@media (max-width: 600px) {
  header {
    font-size:20px;
    text-align:center;
  }

  .filters {
    overflow-x:auto;
    flex-wrap:nowrap;
    padding-bottom:10px;
  }

  .filters::-webkit-scrollbar {
    display:none;
  }

  .container {
    padding:14px;
  }

  .order {
    padding:14px;
  }

  .actions button {
    width:100%;
  }
}

/* ================= TABLET ================= */
@media (min-width: 601px) and (max-width: 1024px) {
  header {
    font-size:22px;
  }

  .actions button {
    flex:1;
  }
}

/* ================= LARGE SCREENS ================= */
@media (min-width: 1400px) {
  .container {
    max-width:1400px;
  }
}
</style>
</head>

<body>

<header>JD Admin – Orders</header>

<div class="filters">
  <button class="active" onclick="setFilter('ALL',this)">All</button>
  <button onclick="setFilter('PLACED',this)">Placed</button>
  <button onclick="setFilter('SHIPPED',this)">Shipped</button>
  <button onclick="setFilter('DELIVERED',this)">Delivered</button>
  <button onclick="setFilter('CANCELLED',this)">Cancelled</button>
</div>

<div class="container" id="orders">Loading...</div>

<script>
"use strict";

/* ================= ADMIN CONFIG ================= */
const BASE_URL = "https://shopx-production-406f.up.railway.app";
const ADMIN_API = BASE_URL + "/api/admin/orders";
const ADMIN_KEY = localStorage.getItem("adminKey");

/* ================= PROTECT ADMIN ================= */
if (!ADMIN_KEY) {
  const key = prompt("Enter Admin Key");
  if (!key) location.href = "../index.html";
  localStorage.setItem("adminKey", key);
}

/* ================= ADMIN FETCH ================= */
function adminFetch(url, options = {}) {
  return fetch(url, {
    ...options,
    headers: {
      "Content-Type": "application/json",
      "x-admin-key": localStorage.getItem("adminKey"),
      ...(options.headers || {})
    }
  });
}

/* ================= STATE ================= */
let allOrders = [];
let currentFilter = "ALL";

/* ================= LOAD ORDERS ================= */
async function loadOrders() {
  try {
    const res = await adminFetch(ADMIN_API);

    if (!res.ok) throw new Error("Unauthorized");

    allOrders = await res.json();
    renderOrders();

  } catch (err) {
    console.error(err);
    document.getElementById("orders").innerHTML =
      "<p style='color:#ef4444'>Failed to load orders</p>";
  }
}

/* ================= FILTER ================= */
function setFilter(status, btn) {
  currentFilter = status;
  document.querySelectorAll(".filters button")
    .forEach(b => b.classList.remove("active"));
  btn.classList.add("active");
  renderOrders();
}

/* ================= RENDER ================= */
function renderOrders() {
  const div = document.getElementById("orders");
  div.innerHTML = "";

  const list = currentFilter === "ALL"
    ? allOrders
    : allOrders.filter(o => o.status === currentFilter);

  if (!list.length) {
    div.innerHTML = "<p>No orders found</p>";
    return;
  }

  list.forEach(o => {
    const total = Number(o.total_amount || 0);
    const deliveredDate = o.delivered_at
      ? new Date(o.delivered_at).toLocaleDateString("en-IN")
      : "";

    const box = document.createElement("div");
    box.className = "order";

    box.innerHTML = `
      <b>Order #${o.id}</b><br>
      Customer: ${o.customer_name || "Guest"}<br>
      <b>Total: ₹${total.toLocaleString("en-IN")}</b>

      <div class="status ${o.status}">Status: ${o.status}</div>
      ${deliveredDate ? `<div>Delivered on: ${deliveredDate}</div>` : ""}

      <div class="items">
        ${o.items.map(i =>
          `${i.name} × ${i.quantity} (₹${i.price})`
        ).join("<br>")}
      </div>

      <div class="actions">
        ${o.status === "PLACED" ? `
          <button class="ship"
            onclick="updateStatus(${o.id},'SHIPPED')">Ship</button>
          <button class="cancel"
            onclick="updateStatus(${o.id},'CANCELLED')">Cancel</button>
        ` : ""}

        ${o.status === "SHIPPED" ? `
          <button class="deliver"
            onclick="updateStatus(${o.id},'DELIVERED')">Deliver</button>
        ` : ""}

        <button class="delete"
          onclick="deleteOrder(${o.id})">Delete</button>
      </div>
    `;

    div.appendChild(box);
  });
}

/* ================= UPDATE STATUS ================= */
async function updateStatus(id, status) {
  if (!confirm(`Mark order as ${status}?`)) return;

  await adminFetch(`${ADMIN_API}/${id}`, {
    method: "PUT",
    body: JSON.stringify({ status })
  });

  loadOrders();
}

/* ================= DELETE ORDER ================= */
async function deleteOrder(id) {
  if (!confirm("Delete this order permanently?")) return;

  await adminFetch(`${ADMIN_API}/${id}`, {
    method: "DELETE"
  });

  loadOrders();
}

/* ================= INIT ================= */
loadOrders();
</script>

</body>
</html>
