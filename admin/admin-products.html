<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin – Products | JD</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:'Poppins',sans-serif;
  background:radial-gradient(circle at top,#0b0b0b,#000);
  color:#e5e7eb;
}
header{
  padding:18px 22px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:rgba(20,20,20,.85);
  backdrop-filter:blur(14px);
  border-bottom:1px solid rgba(255,255,255,.08);
}
header h2{margin:0;font-size:18px}
header button{
  padding:10px 18px;
  border-radius:14px;
  border:none;
  background:#2563eb;
  color:#fff;
  font-weight:600;
  cursor:pointer;
}
.form{
  margin:18px;
  padding:18px;
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:14px;
  background:rgba(255,255,255,.05);
  border-radius:22px;
}
input,textarea{
  padding:13px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.12);
  background:#000;
  color:#fff;
}
textarea{grid-column:1/-1}
.form button{
  grid-column:1/-1;
  padding:15px;
  border-radius:16px;
  border:none;
  background:#22c55e;
  color:#fff;
  font-weight:600;
  cursor:pointer;
}
.products{
  padding:18px;
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(230px,1fr));
  gap:18px;
}
.card{
  background:rgba(255,255,255,.06);
  border-radius:22px;
  padding:14px;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.card img{
  width:100%;
  height:150px;
  object-fit:cover;
  border-radius:16px;
  background:#111;
}
.card button{
  margin-top:auto;
  padding:10px;
  border:none;
  border-radius:14px;
  background:#ef4444;
  color:#fff;
  cursor:pointer;
}
</style>
</head>

<body>

<header>
  <h2>JD Product Management</h2>
  <button onclick="location.href='admin-dashboard.html'">Dashboard</button>
</header>

<div class="form">
  <input id="name" placeholder="Product name">
  <input id="price" type="number" placeholder="Price">
  <input id="category" placeholder="Category">
  <input id="img1" placeholder="Image URL (required)">
  <input id="img2" placeholder="Image URL (optional)">
  <input id="img3" placeholder="Image URL (optional)">
  <textarea id="desc" rows="3" placeholder="Description"></textarea>
  <button id="addBtn">Add Product</button>
</div>

<div class="products" id="list"></div>

<script>
"use strict";

/* ================= CONFIG ================= */
const BASE_URL = "https://shopx-production-b1ad.up.railway.app";
const API = BASE_URL + "/api";

const PUBLIC_PRODUCTS_API = API + "/products";
const ADMIN_PRODUCTS_API = API + "/admin/products";
const LOGIN_PAGE = "admin-login.html";

const FALLBACK_IMAGE =
  "https://via.placeholder.com/600x400?text=No+Image";

/* ================= AUTH HELPERS ================= */
function getToken() {
  return localStorage.getItem("adminToken");
}

function forceLogout() {
  localStorage.removeItem("adminToken");
  location.replace(LOGIN_PAGE);
}

/* ================= AUTH GUARD ================= */
if (!getToken()) {
  forceLogout();
}

/* ================= AUTH FETCH ================= */
async function authFetch(url, options = {}) {
  const token = getToken();
  if (!token) {
    forceLogout();
    throw new Error("No token");
  }

  const res = await fetch(url, {
    ...options,
    headers: {
      Authorization: "Bearer " + token,
      ...(options.headers || {})
    }
  });

  if (res.status === 401 || res.status === 403) {
    forceLogout();
    throw new Error("Unauthorized");
  }

  return res;
}

/* ================= ELEMENTS ================= */
const list = document.getElementById("list");
const addBtn = document.getElementById("addBtn");

const nameInput = document.getElementById("name");
const priceInput = document.getElementById("price");
const categoryInput = document.getElementById("category");
const img1Input = document.getElementById("img1");
const img2Input = document.getElementById("img2");
const img3Input = document.getElementById("img3");
const descInput = document.getElementById("desc");

/* ================= LOAD PRODUCTS ================= */
async function loadProducts() {
  list.innerHTML = "";

  try {
    const res = await fetch(PUBLIC_PRODUCTS_API);
    const products = await res.json();

    if (!Array.isArray(products)) return;

    products.forEach(p => {
      const productId = p.id || p._id;
      const imgSrc = p.images?.[0] || FALLBACK_IMAGE;

      const card = document.createElement("div");
      card.className = "card";

      card.innerHTML = `
        <img src="${imgSrc}" onerror="this.src='${FALLBACK_IMAGE}'">
        <strong>${p.name}</strong>
        <span>₹${p.price}</span>
        <small>${p.category}</small>
        <button>Delete</button>
      `;

      card.querySelector("button").onclick =
        () => deleteProduct(productId);

      list.appendChild(card);
    });

  } catch (err) {
    console.error("Load products error:", err);
    list.innerHTML =
      "<p style='color:#f87171'>Failed to load products</p>";
  }
}

/* ================= ADD PRODUCT ================= */
addBtn.onclick = async () => {
  const images = [
    img1Input.value.trim(),
    img2Input.value.trim(),
    img3Input.value.trim()
  ].filter(Boolean);

  if (!images.length) {
    alert("At least ONE image URL is required");
    return;
  }

  const payload = {
    name: nameInput.value.trim(),
    price: Number(priceInput.value),
    category: categoryInput.value.trim(),
    description: descInput.value.trim(),
    images
  };

  if (!payload.name || !payload.category || isNaN(payload.price)) {
    alert("Name, price & category are required");
    return;
  }

  try {
    const res = await authFetch(ADMIN_PRODUCTS_API, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    await res.json();
    clearForm();
    loadProducts();

  } catch (err) {
    console.error("Add product error:", err);
    alert("Add product failed");
  }
};

/* ================= DELETE PRODUCT ================= */
async function deleteProduct(id) {
  if (!id) return alert("Invalid product ID");
  if (!confirm("Delete product?")) return;

  try {
    await authFetch(`${ADMIN_PRODUCTS_API}/${id}`, {
      method: "DELETE"
    });

    loadProducts();

  } catch (err) {
    console.error("Delete error:", err);
    alert("Delete failed");
  }
}

/* ================= CLEAR FORM ================= */
function clearForm() {
  [
    nameInput,
    priceInput,
    categoryInput,
    img1Input,
    img2Input,
    img3Input,
    descInput
  ].forEach(i => i.value = "");
}

/* ================= INIT ================= */
loadProducts();
</script>


</body>
</html>
